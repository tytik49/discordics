<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Clone: Друзья и DM</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* CSS Переменные */
        :root {
            --bg-dark: #202225; 
            --bg-med: #2F3136; 
            --bg-light: #36393F; 
            --bg-channels: #2F3136; 
            --violet-brand: #5865F2; 
            --violet-active-bg: #40444B; 
            --text-primary: #DCDDDE;
            --text-secondary: #99AAB5;
            --status-online: #43B581;
            --unread-badge: #F23F43; 
            --font-family: 'Montserrat', sans-serif;
            --user-status-offline: #747f8d; 
            --red-delete: #F04747;
        }

        /* Общие и Аутентификационные Стили */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-family); }
        body, html { height: 100%; overflow: hidden; background: var(--bg-dark); transition: background-color 0.5s; }

        .auth-container { width: 480px; padding: 32px; background-color: var(--bg-med); border-radius: 5px; box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.5); text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .auth-container h2 { color: var(--text-primary); font-weight: 700; font-size: 28px; margin-bottom: 5px; }
        .auth-container p { color: var(--text-secondary); font-size: 16px; margin-bottom: 25px; }
        .auth-container label { display: block; text-align: left; color: var(--text-secondary); font-size: 12px; font-weight: 700; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; }
        .auth-container input { width: 100%; padding: 10px; background-color: var(--bg-dark); border: 1px solid #202225; border-radius: 3px; color: var(--text-primary); font-size: 16px; transition: border-color 0.2s; }
        .auth-container input:focus { border-color: var(--violet-brand); outline: none; }
        .auth-container button { width: 100%; padding: 10px; margin-top: 20px; background-color: var(--violet-brand); border: none; border-radius: 3px; color: var(--text-primary); font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .auth-container button:hover { background-color: #4048c1; } 
        .auth-container .error-message { color: var(--unread-badge); margin-top: 15px; font-size: 14px; display: none; }
        .auth-container .link-text { margin-top: 15px; font-size: 12px; color: var(--text-secondary); }
        .auth-container .link-text a { color: var(--violet-brand); text-decoration: none; }

        /* Основной Макет */
        .app-container { display: none; height: 100vh; color: var(--text-primary); }
        .servers-panel { width: 72px; background-color: #1E1F22; padding: 10px 0; flex-shrink: 0; overflow-y: auto; }
        .server-icon { width: 50px; height: 50px; background-color: #36393F; margin: 8px auto; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 1.5em; cursor: pointer; position: relative; transition: border-radius 0.25s ease-out, background-color 0.25s ease-out; border-radius: 50%; }
        #friendsServerIcon { background-color: var(--violet-brand); border-radius: 50%; font-size: 24px; }
        #friendsServerIcon:hover { background-color: var(--violet-brand); border-radius: 50%; transform: scale(1.05); } 
        .server-icon.add-server { background-color: #36393F; border-radius: 50%; font-size: 1.5em; }
        .server-icon.add-server:hover { background-color: var(--status-online); border-radius: 50%; transform: rotate(90deg); }

        /* Левая Панель (Каналы/Друзья) */
        .channels-panel { width: 240px; background-color: var(--bg-channels); display: flex; flex-direction: column; flex-shrink: 0; }
        .channel-header { height: 48px; padding: 0 16px; line-height: 48px; font-weight: 600; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .channel-header input { background: var(--bg-dark); border: none; color: var(--text-primary); padding: 5px 10px; border-radius: 4px; width: 100%; }
        .channel-list { flex-grow: 1; padding: 8px; overflow-y: auto; }
        
        .nav-item { display: flex; align-items: center; height: 42px; padding: 0 8px; border-radius: 4px; cursor: pointer; color: var(--text-secondary); margin: 0 6px 2px 6px; font-size: 16px; font-weight: 500; transition: background-color 0.15s, color 0.15s, transform 0.05s; }
        .nav-item:hover { color: var(--text-primary); background-color: var(--violet-active-bg); }
        .nav-item.active-tab { color: var(--text-primary); background-color: var(--violet-active-bg); font-weight: 600; }
        .nav-item i { margin-right: 12px; font-size: 1.2em; width: 20px; text-align: center; }

        .dm-category { color: var(--text-secondary); font-size: 12px; font-weight: 700; margin: 10px 8px 5px 6px; display: flex; justify-content: space-between; }
        
        /* Список DM */
        .dm-item { display: flex; align-items: center; height: 42px; padding: 0 8px; border-radius: 4px; cursor: pointer; color: var(--text-secondary); margin: 0 6px 2px 6px; font-size: 16px; font-weight: 500; transition: background-color 0.15s, color 0.15s; }
        .dm-item:hover { color: var(--text-primary); background-color: var(--violet-active-bg); }
        .dm-item.active-dm { color: var(--text-primary); background-color: var(--violet-active-bg); }
        .dm-avatar { width: 24px; height: 24px; border-radius: 50%; background-color: var(--status-online); margin-right: 10px; }


        /* Настройки Пользователя внизу */
        .user-settings { height: 54px; background-color: #23272A; padding: 0 8px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .user-settings .controls i { color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 3px; transition: color 0.15s, background-color 0.15s; }
        .user-settings .controls i:hover { color: var(--text-primary); background-color: var(--violet-active-bg); }

        /* Центральная Панель (Чат/Контент) */
        .chat-panel { flex-grow: 1; background-color: var(--bg-med); display: flex; flex-direction: column; }
        .chat-header { height: 48px; padding: 0 16px; line-height: 48px; font-weight: 600; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .message-list { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        
        /* Стили Контента Друзей */
        .friends-content { padding: 24px; }
        .friends-content h2 { font-size: 20px; font-weight: 700; color: var(--text-primary); border-bottom: 1px solid #40444B; padding-bottom: 15px; margin-bottom: 15px; }

        .friends-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; margin-bottom: 5px; border-radius: 4px;
            border-top: 1px solid #40444B;
            transition: background-color 0.15s;
        }
        .friends-list-item:hover { background-color: var(--violet-active-bg); }
        .friend-info { display: flex; align-items: center; cursor: pointer; } /* Добавляем курсор для клика */
        .friend-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: var(--violet-brand); margin-right: 10px; position: relative; }
        .friend-status { width: 10px; height: 10px; border-radius: 50%; border: 3px solid var(--bg-med); position: absolute; bottom: -2px; right: -2px; }
        .status-online { background-color: var(--status-online); }
        
        .friend-name-tag strong { display: block; font-size: 16px; font-weight: 600; }
        .friend-name-tag small { color: var(--text-secondary); font-size: 12px; }
        .friend-actions i { color: var(--text-secondary); cursor: pointer; margin-left: 10px; transition: color 0.15s; }
        .friend-actions i:hover { color: var(--text-primary); }
        .friend-actions .fa-user-times:hover { color: var(--red-delete); }

        /* Форма Добавления Друга */
        .add-friend-form-container { margin-bottom: 25px; padding: 10px; background-color: var(--bg-light); border-radius: 8px; }
        .add-friend-form-container h3 { font-size: 14px; color: var(--text-primary); margin-bottom: 10px; }
        .add-friend-form-container p { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; }
        .add-friend-input-group { display: flex; }
        .add-friend-input-group input { flex-grow: 1; background-color: var(--bg-dark); border: 1px solid #40444B; border-right: none; border-radius: 4px 0 0 4px; padding: 8px; color: var(--text-primary); }
        .add-friend-input-group button { background-color: var(--violet-brand); color: white; border: none; padding: 0 15px; font-weight: 600; cursor: pointer; border-radius: 0 4px 4px 0; transition: background-color 0.2s; }
        .add-friend-input-group button:hover { background-color: #4048c1; }
        .add-friend-message { margin-top: 10px; font-size: 12px; display: none; }
        .message-error { color: var(--unread-badge); }
        .message-success { color: var(--status-online); }
        
        /* Стили для DM-панели */
        .message-input-area { 
            padding: 20px 16px;
            background-color: var(--bg-med); 
        }
        .message-input-area input {
            width: 100%;
            padding: 10px 15px;
            background-color: var(--bg-light);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
        }
    </style>
</head>
<body>

    <div class="auth-container" id="loginScreen">
        <h2>С возвращением!</h2>
        <p>Мы рады видеть вас снова!</p>
        <form id="loginForm">
            <label for="loginEmail">ЭЛ. ПОЧТА ИЛИ ИМЯ ПОЛЬЗОВАТЕЛЯ</label>
            <input type="email" id="loginEmail" required>
            <label for="loginPassword">ПАРОЛЬ</label>
            <input type="password" id="loginPassword" required>
            
            <a href="#" style="color: var(--violet-brand); font-size: 12px; display: block; text-align: left; margin-top: 5px;">Забыли пароль?</a>

            <button type="submit">Войти</button>
            <div class="error-message" id="loginErrorMsg">Неверный email или пароль. Пожалуйста, попробуйте снова.</div>
        </form>
        <div class="link-text">
            Нужен аккаунт? 
            <a href="#" id="showRegister">Зарегистрироваться</a>
        </div>
    </div>

    <div class="auth-container" id="registerScreen" style="display: none;">
        <h2>Создать аккаунт</h2>
        <p>Начните свой фиолетовый путь.</p>
        <form id="registerForm">
            <label for="regEmail">ЭЛ. ПОЧТА</label>
            <input type="email" id="regEmail" required>
            <label for="regUsername">ИМЯ ПОЛЬЗОВАТЕЛЯ</label>
            <input type="text" id="regUsername" required>
            <label for="regPassword">ПАРОЛЬ</label>
            <input type="password" id="regPassword" required>
            
            <button type="submit">Продолжить</button>
            <div class="error-message" id="registerErrorMsg">Произошла ошибка. Пожалуйста, попробуйте снова.</div>
            <div class="error-message" id="registerSuccessMsg" style="color: var(--status-online);">Аккаунт успешно создан!</div>
        </form>
        <div class="link-text">
            Уже зарегистрированы? 
            <a href="#" id="showLogin">Войти</a>
        </div>
    </div>

    <div class="app-container" id="mainApp">
        <div class="servers-panel">
            <div class="server-icon active" id="friendsServerIcon"><i class="fab fa-discord"></i></div>
            <div class="server-icon add-server"><i class="fas fa-plus"></i></div>
        </div>

        <div class="channels-panel">
            <div class="channel-header" id="channelHeader">
                <input type="text" placeholder="Найти или начать беседу">
            </div>
            <div class="channel-list" id="channelList">
                
                </div>

            <div class="user-settings">
                <div class="user-info" style="display: flex; align-items: center;">
                    <span class="avatar online" id="currentUserAvatar"></span>
                    <div class="username-tag">
                        <strong style="font-weight: 600;" id="currentUsername">VioletUser</strong>
                        <span style="font-size: 0.7em; color: var(--text-secondary); font-weight: 400;" id="currentUserDiscriminator">#0000</span>
                    </div>
                </div>
                <div class="controls">
                    <i class="fas fa-cog"></i> 
                    <i class="fas fa-headset"></i> 
                    <i class="fas fa-microphone-slash"></i>
                    <i class="fas fa-sign-out-alt" id="logoutButton" title="Выйти"></i>
                </div>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header" id="chatHeaderContent">
                <i class="fas fa-user-friends" style="margin-right: 8px;"></i>Друзья
            </div>
            <div class="message-list" id="messageList" style="padding: 0;">
                </div>
            
            <form id="chatForm" class="message-input-area" style="display: none;">
                <input type="text" id="chatInput" placeholder="Начать личное сообщение">
            </form>
        </div>

        <div class="members-panel" style="width: 0; background-color: var(--bg-med);">
        </div>
    </div>

    <script>
        // --- Элементы UI ---
        const loginScreen = document.getElementById('loginScreen');
        const registerScreen = document.getElementById('registerScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginErrorMsg = document.getElementById('loginErrorMsg');
        const registerErrorMsg = document.getElementById('registerErrorMsg');
        const registerSuccessMsg = document.getElementById('registerSuccessMsg');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const channelList = document.getElementById('channelList');
        const chatHeaderContent = document.getElementById('chatHeaderContent');
        const messageList = document.getElementById('messageList');
        const chatForm = document.getElementById('chatForm');
        const currentUsernameEl = document.getElementById('currentUsername');
        const currentUserDiscriminatorEl = document.getElementById('currentUserDiscriminator'); 
        const logoutButton = document.getElementById('logoutButton');

        const USER_TOKEN_KEY = 'discordCloneUserToken';
        let currentActiveUser = null; 
        let activeDM = null; // ID друга, с которым открыт чат

        // --- ДАННЫЕ (ИМИТАЦИЯ) ---
        // Имитация базы данных сообщений. Ключ - конкатенация ID пользователей.
        let messagesDB = JSON.parse(localStorage.getItem('messagesDB')) || {};

        function saveMessages() {
            localStorage.setItem('messagesDB', JSON.stringify(messagesDB));
        }

        const contentData = {
            'friends-home': { title: 'Друзья', icon: 'fas fa-user-friends', content: getFriendsHomeContent, hasInput: false },
            'nitro': { title: 'Nitro', icon: 'fas fa-crown', content: getNitroContent, hasInput: false },
            'store': { title: 'Магазин', icon: 'fas fa-store', content: getStoreContent, hasInput: false },
            'tasks': { title: 'Задания', icon: 'fas fa-cog', content: getTasksContent, hasInput: false },
        };

        // --- ФУНКЦИИ УПРАВЛЕНИЯ ДАННЫМИ (Local Storage) ---
        
        function generateDiscriminator() {
            // Генерирует случайное 4-значное число (0000-9999)
            return '#' + Math.floor(1000 + Math.random() * 9000);
        }

        function generateToken() {
            return 'token-' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function encryptPassword(password) { return btoa(password); }
        function decryptPassword(encodedPassword) { return atob(encodedPassword); }

        function getAllUsers() {
            return JSON.parse(localStorage.getItem('users')) || [];
        }

        function findUserById(id) {
            return getAllUsers().find(u => u.id === id);
        }

        function findUserByEmail(email) {
            return getAllUsers().find(u => u.email === email);
        }

        function findUserByTag(tag) {
            const parts = tag.split('#');
            if (parts.length !== 2) return null;

            const targetUsername = parts[0].toLowerCase().trim(); 
            const targetDiscriminatorNumber = '#' + parts[1].trim(); 
            
            if (!targetUsername || parts[1].trim().length !== 4 || isNaN(parseInt(parts[1].trim()))) return null;

            return getAllUsers().find(u => 
                u.username.toLowerCase() === targetUsername && 
                u.discriminator === targetDiscriminatorNumber
            );
        }

        function findUserByToken(token) {
            return getAllUsers().find(u => u.token === token);
        }

        function saveUser(user) {
            let storedUsers = getAllUsers();
            storedUsers = storedUsers.filter(u => u.id !== user.id); 
            storedUsers.push(user);
            localStorage.setItem('users', JSON.stringify(storedUsers));
        }

        // --- ФУНКЦИИ СЕССИИ И АУТЕНТИФИКАЦИИ ---

        function initializeApp(user) {
            currentActiveUser = user; 
            
            if (!user.friends) {
                user.friends = [];
                saveUser(user);
            }

            loginScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            document.body.style.backgroundColor = 'var(--bg-med)';
            
            currentUsernameEl.textContent = user.username;
            currentUserDiscriminatorEl.textContent = user.discriminator || '#0000'; 
            
            // Сбрасываем активный DM
            activeDM = null;
            
            // Загружаем навигацию и контент по умолчанию
            channelList.innerHTML = getFriendsNav();
            loadContent('friends-home');
        }

        function loginUser(user) {
            const token = generateToken();
            user.token = token;
            
            saveUser(user);
            localStorage.setItem(USER_TOKEN_KEY, token);

            initializeApp(user);
        }

        function logoutUser() {
            localStorage.removeItem(USER_TOKEN_KEY);
            currentActiveUser = null;
            mainApp.style.display = 'none';
            showScreen('login');
        }

        // --- ЛОГИКА ДОБАВЛЕНИЯ/УДАЛЕНИЯ ДРУЗЕЙ ---

        function addFriendLogic(friendTag) {
            const token = localStorage.getItem(USER_TOKEN_KEY);
            let activeUser = findUserByToken(token); 

            const msgEl = document.getElementById('addFriendMessage');
            msgEl.style.display = 'none';

            if (!activeUser) {
                msgEl.textContent = 'Ошибка сессии. Попробуйте войти снова.';
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            const friend = findUserByTag(friendTag); 

            if (!friend) {
                msgEl.textContent = `Пользователь с тегом "${friendTag}" не найден. Убедитесь, что дискриминатор верен.`;
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            if (friend.id === activeUser.id) {
                msgEl.textContent = 'Вы не можете добавить самого себя.';
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            if (activeUser.friends.includes(friend.id)) {
                msgEl.textContent = `${friend.username}${friend.discriminator} уже ваш друг!`;
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            // Добавление
            activeUser.friends.push(friend.id);
            saveUser(activeUser);
            
            // Двустороннее добавление
            if (!friend.friends) friend.friends = [];
            if (!friend.friends.includes(activeUser.id)) {
                friend.friends.push(activeUser.id);
                saveUser(friend);
            }
            
            msgEl.textContent = `Успешно добавлен ${friend.username}${friend.discriminator}!`;
            msgEl.className = 'add-friend-message message-success';
            msgEl.style.display = 'block';
            
            initializeApp(activeUser); 
        }

        function removeFriendLogic(friendId) {
            if (!confirm("Вы уверены, что хотите удалить этого друга?")) return;

            const token = localStorage.getItem(USER_TOKEN_KEY);
            let activeUser = findUserByToken(token);
            let friendToRemove = getAllUsers().find(u => u.id === friendId);

            if (!activeUser || !friendToRemove) return;

            // Удаление из списка текущего пользователя
            activeUser.friends = activeUser.friends.filter(id => id !== friendId);
            saveUser(activeUser);

            // Удаление из списка друга
            if (friendToRemove.friends) {
                friendToRemove.friends = friendToRemove.friends.filter(id => id !== activeUser.id);
                saveUser(friendToRemove);
            }

            initializeApp(activeUser);
        }

        // --- ЛОГИКА DM (ЧАТ) ---

        function getDMKey(friendId) {
            // Создает уникальный ключ для чата, не зависящий от порядка ID
            const ids = [currentActiveUser.id, friendId].sort();
            return ids.join('_');
        }

        function loadDMChat(friendId) {
            const friend = findUserById(friendId);
            if (!friend) return;

            activeDM = friendId;
            const dmKey = getDMKey(friendId);
            
            // Обновление заголовка
            chatHeaderContent.innerHTML = `
                <div class="dm-avatar" style="background-color: var(--violet-brand);"></div>
                ${friend.username}
            `;
            
            // Загрузка сообщений
            const messages = messagesDB[dmKey] || [];
            messageList.innerHTML = messages.map(msg => `
                <div style="margin-bottom: 15px; font-size: 14px;">
                    <strong style="color: ${msg.senderId === currentActiveUser.id ? 'var(--status-online)' : 'var(--violet-brand)'};">${findUserById(msg.senderId).username}</strong>
                    <span style="color: var(--text-secondary); font-size: 10px;"> (${new Date(msg.timestamp).toLocaleTimeString()})</span>
                    <p style="margin-top: 2px;">${msg.content}</p>
                </div>
            `).join('');

            // Активация поля ввода
            chatForm.style.display = 'flex';
            const chatInput = document.getElementById('chatInput');
            chatInput.placeholder = `Написать @${friend.username}`;
            chatInput.focus();
            
            // Прокрутка вниз
            messageList.scrollTop = messageList.scrollHeight;
            
            // Обновление списка DM (активный класс)
            updateDMListActiveState(friendId);
        }

        function sendMessage(content) {
            if (!content || !activeDM) return;
            
            const dmKey = getDMKey(activeDM);
            
            if (!messagesDB[dmKey]) {
                messagesDB[dmKey] = [];
            }

            const message = {
                senderId: currentActiveUser.id,
                content: content,
                timestamp: Date.now()
            };
            
            messagesDB[dmKey].push(message);
            saveMessages();
            
            // Перезагрузка чата для отображения нового сообщения
            loadDMChat(activeDM); 
        }


        // --- ФОРМИРОВАНИЕ HTML КОНТЕНТА ---
        
        function getDMListHTML() {
            const friends = currentActiveUser.friends.map(friendId => 
                getAllUsers().find(u => u.id === friendId)
            ).filter(f => f !== undefined);
            
            return friends.map(friend => `
                <div class="dm-item" data-friend-id="${friend.id}" data-type="dm">
                    <div class="dm-avatar" style="background-color: ${friend.id === activeDM ? 'var(--violet-brand)' : 'var(--status-online)'};"></div>
                    ${friend.username}
                </div>
            `).join('');
        }
        
        function getFriendsNav() {
            return `
                <div class="nav-item active-tab" data-target="friends-home">
                    <i class="fas fa-user-friends"></i> Друзья
                </div>
                <div class="nav-item" data-target="nitro">
                    <i class="fas fa-crown"></i> Nitro
                </div>
                <div class="dm-category">
                    Личные сообщения <i class="fas fa-plus" style="font-size: 10px; cursor: pointer;"></i>
                </div>
                ${getDMListHTML()}
                `;
        }

        function getFriendsHomeContent() {
            const friends = currentActiveUser.friends.map(friendId => 
                getAllUsers().find(u => u.id === friendId)
            ).filter(f => f !== undefined);

            let friendsListHTML = '';
            
            if (friends.length === 0) {
                friendsListHTML = `<p style="color: var(--text-secondary); font-size: 14px; margin-top: 15px; padding: 0 10px;">Начните добавлять друзей с помощью его полного тега (Имя#XXXX).</p>`;
            } else {
                friendsListHTML = friends.map(friend => `
                    <div class="friends-list-item" data-friend-id="${friend.id}">
                        <div class="friend-info" data-friend-id="${friend.id}">
                            <div class="friend-avatar">
                                <span class="friend-status status-online"></span>
                            </div>
                            <div class="friend-name-tag">
                                <strong>${friend.username}</strong>
                                <small>В сети</small>
                                <small style="color: var(--text-secondary); margin-left: 5px;">${friend.discriminator || '#0000'}</small>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <i class="fas fa-comment start-dm-btn" title="Начать чат" data-friend-id="${friend.id}"></i>
                            <i class="fas fa-user-times remove-friend-btn" title="Удалить друга" data-friend-id="${friend.id}"></i>
                        </div>
                    </div>
                `).join('');
            }

            const currentDisc = currentActiveUser.discriminator || '#0000';
            return `
                <div class="friends-content" style="padding: 0 10px;">
                    <div class="add-friend-form-container">
                        <h3>ДОБАВИТЬ В ДРУЗЬЯ</h3>
                        <p>Вы можете добавить друга с помощью его полного тега (например, ${currentActiveUser.username}${currentDisc}).</p>
                        <form id="addFriendForm" class="add-friend-input-group">
                            <input type="text" id="friendTagInput" placeholder="Введите имя пользователя#дискриминатор">
                            <button type="submit">Отправить запрос</button>
                        </form>
                        <div id="addFriendMessage" class="add-friend-message"></div>
                    </div>

                    <h2 style="color: var(--text-secondary); padding-bottom: 10px; margin-bottom: 10px;">ДРУЗЬЯ — ${friends.length}</h2>
                    <div id="friendsListContainer">
                        ${friendsListHTML}
                    </div>
                </div>
            `;
        }

        function getNitroContent() { 
            activeDM = null;
            chatForm.style.display = 'none';
            return `<div class="friends-content"><h2>DISCORD NITRO</h2><p style="color: var(--text-secondary); font-size: 14px;">Покупайте Nitro и поддержите нас!</p></div>`; 
        }
        function getStoreContent() { 
            activeDM = null;
            chatForm.style.display = 'none';
            return `<div class="friends-content"><h2>МАГАЗИН</h2><p style="color: var(--text-secondary); font-size: 14px;">Эксклюзивные товары.</p></div>`; 
        }
        function getTasksContent() { 
            activeDM = null;
            chatForm.style.display = 'none';
            return `<div class="friends-content"><h2>ЗАДАНИЯ</h2><p style="color: var(--text-secondary); font-size: 14px;">Нет активных заданий.</p></div>`; 
        }
        
        // --- ЛОГИКА ЗАГРУЗКИ КОНТЕНТА И ОБРАБОТЧИКИ ---
        
        function updateDMListActiveState(friendId) {
            document.querySelectorAll('.dm-item').forEach(i => i.classList.remove('active-dm'));
            const activeItem = document.querySelector(`.dm-item[data-friend-id="${friendId}"]`);
            if (activeItem) {
                activeItem.classList.add('active-dm');
            }
            // Снимаем активный класс с вкладок навигации
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active-tab'));
        }

        function loadContent(key) {
            const data = contentData[key];
            
            chatHeaderContent.innerHTML = `<i class="${data.icon}" style="margin-right: 8px; color: ${key === 'friends-home' ? 'var(--text-primary)' : 'var(--text-secondary)'};"></i>${data.title}`;
            
            if (typeof data.content === 'function') {
                messageList.innerHTML = data.content();
            } else {
                messageList.innerHTML = data.content;
            }
            
            chatForm.style.display = data.hasInput ? 'flex' : 'none';
            activeDM = null; // Сбрасываем DM при переходе на вкладку
            
            if (key === 'friends-home') {
                const addFriendForm = document.getElementById('addFriendForm');
                const friendsListContainer = document.getElementById('friendsListContainer');

                if (addFriendForm) {
                    addFriendForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const tagInput = document.getElementById('friendTagInput');
                        addFriendLogic(tagInput.value);
                        tagInput.value = '';
                    });
                }
                
                if (friendsListContainer) {
                    friendsListContainer.addEventListener('click', function(e) {
                        const removeBtn = e.target.closest('.remove-friend-btn');
                        const startDmBtn = e.target.closest('.friend-info') || e.target.closest('.start-dm-btn');

                        if (removeBtn) {
                            const friendId = removeBtn.getAttribute('data-friend-id');
                            removeFriendLogic(friendId);
                        } else if (startDmBtn) {
                            const friendId = startDmBtn.getAttribute('data-friend-id');
                            // Переход в чат DM
                            loadDMChat(friendId);
                        }
                    });
                }
            }
        }
        
        // --- ОБРАБОТЧИКИ АУТЕНТИФИКАЦИИ И ИНИЦИАЛИЗАЦИЯ ---

        registerForm.addEventListener('submit', function(event) {
            event.preventDefault();
            registerErrorMsg.style.display = 'none';
            registerSuccessMsg.style.display = 'none';
            const email = document.getElementById('regEmail').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            
            if (!email || !username || !password) {
                registerErrorMsg.textContent = 'Пожалуйста, заполните все поля.';
                registerErrorMsg.style.display = 'block';
                return;
            }
            if (findUserByEmail(email)) {
                registerErrorMsg.textContent = 'Пользователь с таким email уже существует.';
                registerErrorMsg.style.display = 'block';
                return;
            }

            const newUser = {
                email: email,
                username: username,
                password: encryptPassword(password), 
                token: null,
                id: Date.now().toString(),
                friends: [],
                discriminator: generateDiscriminator() 
            };
            
            saveUser(newUser);
            
            registerSuccessMsg.innerHTML = `Аккаунт создан! Ваш тег: <strong>${newUser.username}${newUser.discriminator}</strong>`;
            registerSuccessMsg.style.display = 'block';
            
            registerForm.reset(); 
            setTimeout(() => { showScreen('login'); }, 3000); 
        });

        // *** ИСПРАВЛЕНИЕ: Это стандартный обработчик, который должен работать, если кнопка имеет type="submit" ***
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            loginErrorMsg.style.display = 'none';
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const user = findUserByEmail(email);
            if (user && decryptPassword(user.password) === password) {
                loginUser(user);
            } else {
                loginErrorMsg.style.display = 'block';
            }
        });
        
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            sendMessage(input.value);
            input.value = '';
        });

        logoutButton.addEventListener('click', logoutUser);
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showScreen('register'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showScreen('login'); });

        function showScreen(screenName) {
            loginScreen.style.display = 'none';
            registerScreen.style.display = 'none';
            mainApp.style.display = 'none';
            if (screenName === 'login') {
                loginScreen.style.display = 'block';
                loginErrorMsg.style.display = 'none';
            } else if (screenName === 'register') {
                registerScreen.style.display = 'block';
                registerErrorMsg.style.display = 'none';
                registerSuccessMsg.style.display = 'none';
            } else if (screenName === 'app') {
                mainApp.style.display = 'flex';
            }
        }

        channelList.addEventListener('click', (e) => {
            const item = e.target.closest('.nav-item') || e.target.closest('.dm-item');
            if (!item) return;
            
            const targetKey = item.getAttribute('data-target');
            const friendId = item.getAttribute('data-friend-id');

            // Обработка клика на вкладку навигации
            if (targetKey) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active-tab'));
                document.querySelectorAll('.dm-item').forEach(i => i.classList.remove('active-dm'));
                item.classList.add('active-tab');
                loadContent(targetKey);
            } 
            
            // Обработка клика на DM
            if (friendId && item.getAttribute('data-type') === 'dm') {
                loadDMChat(friendId);
            }
        });

        document.querySelector('.servers-panel').addEventListener('click', (e) => {
            const icon = e.target.closest('.server-icon');
            if (!icon) return;
            document.querySelectorAll('.server-icon').forEach(i => i.classList.remove('active'));
            icon.classList.add('active');
            if (icon.id === 'friendsServerIcon') {
                document.getElementById('channelHeader').innerHTML = '<input type="text" placeholder="Найти или начать беседу">';
                channelList.innerHTML = getFriendsNav();
                loadContent('friends-home');
            } 
        });

        function checkSessionToken() {
            const token = localStorage.getItem(USER_TOKEN_KEY);
            if (token) {
                const user = findUserByToken(token);
                if (user) {
                    initializeApp(user); 
                    return;
                } else {
                    localStorage.removeItem(USER_TOKEN_KEY);
                }
            }
            showScreen('login');
        }
        
        checkSessionToken(); 
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Clone: Финальная Версия Друзей</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* CSS Переменные */
        :root {
            --bg-dark: #202225; 
            --bg-med: #2F3136; 
            --bg-light: #36393F; 
            --bg-channels: #2F3136; 
            --violet-brand: #5865F2; 
            --violet-active-bg: #40444B; 
            --text-primary: #DCDDDE;
            --text-secondary: #99AAB5;
            --status-online: #43B581;
            --unread-badge: #F23F43; 
            --font-family: 'Montserrat', sans-serif;
            --user-status-offline: #747f8d; 
            --red-delete: #F04747;
        }

        /* Общие и Аутентификационные Стили */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-family); }
        body, html { height: 100%; overflow: hidden; background: var(--bg-dark); transition: background-color 0.5s; }

        .auth-container { width: 480px; padding: 32px; background-color: var(--bg-med); border-radius: 5px; box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.5); text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .auth-container h2 { color: var(--text-primary); font-weight: 700; font-size: 28px; margin-bottom: 5px; }
        .auth-container p { color: var(--text-secondary); font-size: 16px; margin-bottom: 25px; }
        .auth-container label { display: block; text-align: left; color: var(--text-secondary); font-size: 12px; font-weight: 700; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; }
        .auth-container input { width: 100%; padding: 10px; background-color: var(--bg-dark); border: 1px solid #202225; border-radius: 3px; color: var(--text-primary); font-size: 16px; transition: border-color 0.2s; }
        .auth-container input:focus { border-color: var(--violet-brand); outline: none; }
        .auth-container button { width: 100%; padding: 10px; margin-top: 20px; background-color: var(--violet-brand); border: none; border-radius: 3px; color: var(--text-primary); font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .auth-container button:hover { background-color: #4048c1; } 
        .auth-container .error-message { color: var(--unread-badge); margin-top: 15px; font-size: 14px; display: none; }
        .auth-container .link-text { margin-top: 15px; font-size: 12px; color: var(--text-secondary); }
        .auth-container .link-text a { color: var(--violet-brand); text-decoration: none; }

        /* Основной Макет */
        .app-container { display: none; height: 100vh; color: var(--text-primary); }
        .servers-panel { width: 72px; background-color: #1E1F22; padding: 10px 0; flex-shrink: 0; overflow-y: auto; }
        .server-icon { width: 50px; height: 50px; background-color: #36393F; margin: 8px auto; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-size: 1.5em; cursor: pointer; position: relative; transition: border-radius 0.25s ease-out, background-color 0.25s ease-out; border-radius: 50%; }
        #friendsServerIcon { background-color: var(--violet-brand); border-radius: 50%; font-size: 24px; }
        #friendsServerIcon:hover { background-color: var(--violet-brand); border-radius: 50%; transform: scale(1.05); } 
        .server-icon.add-server { background-color: #36393F; border-radius: 50%; font-size: 1.5em; }
        .server-icon.add-server:hover { background-color: var(--status-online); border-radius: 50%; transform: rotate(90deg); }

        /* Левая Панель (Каналы/Друзья) */
        .channels-panel { width: 240px; background-color: var(--bg-channels); display: flex; flex-direction: column; flex-shrink: 0; }
        .channel-header { height: 48px; padding: 0 16px; line-height: 48px; font-weight: 600; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .channel-header input { background: var(--bg-dark); border: none; color: var(--text-primary); padding: 5px 10px; border-radius: 4px; width: 100%; }
        .channel-list { flex-grow: 1; padding: 8px; overflow-y: auto; }
        
        .nav-item { display: flex; align-items: center; height: 42px; padding: 0 8px; border-radius: 4px; cursor: pointer; color: var(--text-secondary); margin: 0 6px 2px 6px; font-size: 16px; font-weight: 500; transition: background-color 0.15s, color 0.15s, transform 0.05s; }
        .nav-item:hover { color: var(--text-primary); background-color: var(--violet-active-bg); }
        .nav-item.active-tab { color: var(--text-primary); background-color: var(--violet-active-bg); font-weight: 600; }
        .nav-item i { margin-right: 12px; font-size: 1.2em; width: 20px; text-align: center; }

        .dm-category { color: var(--text-secondary); font-size: 12px; font-weight: 700; margin: 10px 8px 5px 6px; display: flex; justify-content: space-between; }
        
        /* Настройки Пользователя внизу */
        .user-settings { height: 54px; background-color: #23272A; padding: 0 8px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .user-settings .controls i { color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 3px; transition: color 0.15s, background-color 0.15s; }
        .user-settings .controls i:hover { color: var(--text-primary); background-color: var(--violet-active-bg); }

        /* Центральная Панель (Чат/Контент) */
        .chat-panel { flex-grow: 1; background-color: var(--bg-med); display: flex; flex-direction: column; }
        .chat-header { height: 48px; padding: 0 16px; line-height: 48px; font-weight: 600; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        .message-list { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        
        /* Стили Контента Друзей */
        .friends-content { padding: 24px; }
        .friends-content h2 { font-size: 20px; font-weight: 700; color: var(--text-primary); border-bottom: 1px solid #40444B; padding-bottom: 15px; margin-bottom: 15px; }

        .friends-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; margin-bottom: 5px; border-radius: 4px;
            border-top: 1px solid #40444B;
            transition: background-color 0.15s;
        }
        .friends-list-item:hover { background-color: var(--violet-active-bg); }
        .friend-info { display: flex; align-items: center; }
        .friend-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: var(--violet-brand); margin-right: 10px; position: relative; }
        .friend-status { width: 10px; height: 10px; border-radius: 50%; border: 3px solid var(--bg-med); position: absolute; bottom: -2px; right: -2px; }
        .status-online { background-color: var(--status-online); }
        
        .friend-name-tag strong { display: block; font-size: 16px; font-weight: 600; }
        .friend-name-tag small { color: var(--text-secondary); font-size: 12px; }
        .friend-actions i { color: var(--text-secondary); cursor: pointer; margin-left: 10px; transition: color 0.15s; }
        .friend-actions i:hover { color: var(--text-primary); }
        .friend-actions .fa-user-times:hover { color: var(--red-delete); }

        /* Форма Добавления Друга */
        .add-friend-form-container { margin-bottom: 25px; padding: 10px; background-color: var(--bg-light); border-radius: 8px; }
        .add-friend-form-container h3 { font-size: 14px; color: var(--text-primary); margin-bottom: 10px; }
        .add-friend-form-container p { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; }
        .add-friend-input-group { display: flex; }
        .add-friend-input-group input { flex-grow: 1; background-color: var(--bg-dark); border: 1px solid #40444B; border-right: none; border-radius: 4px 0 0 4px; padding: 8px; color: var(--text-primary); }
        .add-friend-input-group button { background-color: var(--violet-brand); color: white; border: none; padding: 0 15px; font-weight: 600; cursor: pointer; border-radius: 0 4px 4px 0; transition: background-color 0.2s; }
        .add-friend-input-group button:hover { background-color: #4048c1; }
        .add-friend-message { margin-top: 10px; font-size: 12px; display: none; }
        .message-error { color: var(--unread-badge); }
        .message-success { color: var(--status-online); }
    </style>
</head>
<body>

    <div class="auth-container" id="loginScreen">
        <h2>С возвращением!</h2>
        <p>Мы рады видеть вас снова!</p>
        <form id="loginForm">
            <label for="loginEmail">ЭЛ. ПОЧТА ИЛИ ИМЯ ПОЛЬЗОВАТЕЛЯ</label>
            <input type="email" id="loginEmail" required>
            <label for="loginPassword">ПАРОЛЬ</label>
            <input type="password" id="loginPassword" required>
            
            <a href="#" style="color: var(--violet-brand); font-size: 12px; display: block; text-align: left; margin-top: 5px;">Забыли пароль?</a>

            <button type="submit">Войти</button>
            <div class="error-message" id="loginErrorMsg">Неверный email или пароль. Пожалуйста, попробуйте снова.</div>
        </form>
        <div class="link-text">
            Нужен аккаунт? 
            <a href="#" id="showRegister">Зарегистрироваться</a>
        </div>
    </div>

    <div class="auth-container" id="registerScreen" style="display: none;">
        <h2>Создать аккаунт</h2>
        <p>Начните свой фиолетовый путь.</p>
        <form id="registerForm">
            <label for="regEmail">ЭЛ. ПОЧТА</label>
            <input type="email" id="regEmail" required>
            <label for="regUsername">ИМЯ ПОЛЬЗОВАТЕЛЯ</label>
            <input type="text" id="regUsername" required>
            <label for="regPassword">ПАРОЛЬ</label>
            <input type="password" id="regPassword" required>
            
            <button type="submit">Продолжить</button>
            <div class="error-message" id="registerErrorMsg">Произошла ошибка. Пожалуйста, попробуйте снова.</div>
            <div class="error-message" id="registerSuccessMsg" style="color: var(--status-online);">Аккаунт успешно создан!</div>
        </form>
        <div class="link-text">
            Уже зарегистрированы? 
            <a href="#" id="showLogin">Войти</a>
        </div>
    </div>

    <div class="app-container" id="mainApp">
        <div class="servers-panel">
            <div class="server-icon active" id="friendsServerIcon"><i class="fab fa-discord"></i></div>
            <div class="server-icon add-server"><i class="fas fa-plus"></i></div>
        </div>

        <div class="channels-panel">
            <div class="channel-header" id="channelHeader">
                <input type="text" placeholder="Найти или начать беседу">
            </div>
            <div class="channel-list" id="channelList">
                
                <div class="nav-item active-tab" data-target="friends-home">
                    <i class="fas fa-user-friends"></i> Друзья
                </div>
                <div class="nav-item" data-target="nitro">
                    <i class="fas fa-crown"></i> Nitro
                </div>
                <div class="nav-item" data-target="store">
                    <i class="fas fa-store"></i> Магазин
                </div>
                <div class="nav-item" data-target="tasks">
                    <i class="fas fa-cog"></i> Задания
                </div>
                
                <div class="dm-category">
                    Личные сообщения <i class="fas fa-plus" style="font-size: 10px; cursor: pointer;"></i>
                </div>
            </div>

            <div class="user-settings">
                <div class="user-info" style="display: flex; align-items: center;">
                    <span class="avatar online" id="currentUserAvatar"></span>
                    <div class="username-tag">
                        <strong style="font-weight: 600;" id="currentUsername">VioletUser</strong>
                        <span style="font-size: 0.7em; color: var(--text-secondary); font-weight: 400;" id="currentUserDiscriminator">#0000</span>
                    </div>
                </div>
                <div class="controls">
                    <i class="fas fa-cog"></i> 
                    <i class="fas fa-headset"></i> 
                    <i class="fas fa-microphone-slash"></i>
                    <i class="fas fa-sign-out-alt" id="logoutButton" title="Выйти"></i>
                </div>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header" id="chatHeaderContent">
                <i class="fas fa-user-friends" style="margin-right: 8px;"></i>Друзья
            </div>
            <div class="message-list" id="messageList" style="padding: 0;">
                </div>
            
            <form id="chatForm" class="message-input-area" style="display: none;">
                <input type="text" id="chatInput" placeholder="Начать личное сообщение" required>
            </form>
        </div>

        <div class="members-panel" style="width: 0; background-color: var(--bg-med);">
        </div>
    </div>

    <script>
        // --- Элементы UI ---
        const loginScreen = document.getElementById('loginScreen');
        const registerScreen = document.getElementById('registerScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginErrorMsg = document.getElementById('loginErrorMsg');
        const registerErrorMsg = document.getElementById('registerErrorMsg');
        const registerSuccessMsg = document.getElementById('registerSuccessMsg');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const channelList = document.getElementById('channelList');
        const chatHeaderContent = document.getElementById('chatHeaderContent');
        const messageList = document.getElementById('messageList');
        const chatForm = document.getElementById('chatForm');
        const currentUsernameEl = document.getElementById('currentUsername');
        const currentUserDiscriminatorEl = document.getElementById('currentUserDiscriminator'); 
        const logoutButton = document.getElementById('logoutButton');

        const USER_TOKEN_KEY = 'discordCloneUserToken';
        let currentActiveUser = null; 

        // --- ДАННЫЕ (ИМИТАЦИЯ) ---
        const contentData = {
            'friends-home': { title: 'Друзья', icon: 'fas fa-user-friends', content: getFriendsHomeContent, hasInput: false },
            'nitro': { title: 'Nitro', icon: 'fas fa-crown', content: getNitroContent, hasInput: false },
            'store': { title: 'Магазин', icon: 'fas fa-store', content: getStoreContent, hasInput: false },
            'tasks': { title: 'Задания', icon: 'fas fa-cog', content: getTasksContent, hasInput: false },
        };

        // --- ФУНКЦИИ УПРАВЛЕНИЯ ДАННЫМИ (Local Storage) ---
        
        function generateDiscriminator() {
            // Генерирует случайное 4-значное число (0000-9999)
            return '#' + Math.floor(1000 + Math.random() * 9000);
        }

        function generateToken() {
            return 'token-' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function encryptPassword(password) { return btoa(password); }
        function decryptPassword(encodedPassword) { return atoa(encodedPassword); }

        function getAllUsers() {
            return JSON.parse(localStorage.getItem('users')) || [];
        }

        function findUserByEmail(email) {
            return getAllUsers().find(u => u.email === email);
        }

        // --- ФИНАЛЬНАЯ, НАДЕЖНАЯ ФУНКЦИЯ ПОИСКА ДРУГА ---
        function findUserByTag(tag) {
            // Убеждаемся, что тег содержит разделитель
            const parts = tag.split('#');
            if (parts.length !== 2) return null;

            // 1. Приводим имя пользователя к нижнему регистру и обрезаем пробелы
            const targetUsername = parts[0].toLowerCase().trim(); 
            // 2. Форматируем дискриминатор и обрезаем пробелы
            const targetDiscriminatorNumber = '#' + parts[1].trim(); 
            
            // Проверка формата дискриминатора: 4 цифры
            if (!targetUsername || parts[1].trim().length !== 4 || isNaN(parseInt(parts[1].trim()))) return null;

            // 3. Ищем, сравнивая имена в нижнем регистре и дискриминатор точно
            return getAllUsers().find(u => 
                u.username.toLowerCase() === targetUsername && 
                u.discriminator === targetDiscriminatorNumber
            );
        }

        function findUserByToken(token) {
            return getAllUsers().find(u => u.token === token);
        }

        function saveUser(user) {
            let storedUsers = getAllUsers();
            storedUsers = storedUsers.filter(u => u.id !== user.id); 
            storedUsers.push(user);
            localStorage.setItem('users', JSON.stringify(storedUsers));
        }

        // --- ФУНКЦИИ СЕССИИ И АУТЕНТИФИКАЦИИ ---

        function initializeApp(user) {
            currentActiveUser = user; 
            
            if (!user.friends) {
                user.friends = [];
                saveUser(user);
            }

            loginScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            document.body.style.backgroundColor = 'var(--bg-med)';
            
            currentUsernameEl.textContent = user.username;
            // Здесь отображаем дискриминатор, который СГЕНЕРИРОВАЛА СИСТЕМА
            currentUserDiscriminatorEl.textContent = user.discriminator || '#0000'; 
            
            loadContent('friends-home');
        }

        function loginUser(user) {
            const token = generateToken();
            user.token = token;
            
            saveUser(user);
            localStorage.setItem(USER_TOKEN_KEY, token);

            initializeApp(user);
        }

        function logoutUser() {
            localStorage.removeItem(USER_TOKEN_KEY);
            currentActiveUser = null;
            mainApp.style.display = 'none';
            showScreen('login');
        }

        // --- ЛОГИКА ДОБАВЛЕНИЯ/УДАЛЕНИЯ ДРУЗЕЙ ---

        function addFriendLogic(friendTag) {
            const token = localStorage.getItem(USER_TOKEN_KEY);
            let activeUser = findUserByToken(token); 

            const msgEl = document.getElementById('addFriendMessage');
            msgEl.style.display = 'none';

            if (!activeUser) {
                msgEl.textContent = 'Ошибка сессии. Попробуйте войти снова.';
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            const friend = findUserByTag(friendTag); 

            if (!friend) {
                msgEl.textContent = `Пользователь с тегом "${friendTag}" не найден. Убедитесь, что дискриминатор верен.`;
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            if (friend.id === activeUser.id) {
                msgEl.textContent = 'Вы не можете добавить самого себя.';
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            if (activeUser.friends.includes(friend.id)) {
                msgEl.textContent = `${friend.username}${friend.discriminator} уже ваш друг!`;
                msgEl.className = 'add-friend-message message-error';
                msgEl.style.display = 'block';
                return;
            }

            // Добавление
            activeUser.friends.push(friend.id);
            saveUser(activeUser);
            
            // Двустороннее добавление
            if (!friend.friends) friend.friends = [];
            if (!friend.friends.includes(activeUser.id)) {
                friend.friends.push(activeUser.id);
                saveUser(friend);
            }
            
            msgEl.textContent = `Успешно добавлен ${friend.username}${friend.discriminator}!`;
            msgEl.className = 'add-friend-message message-success';
            msgEl.style.display = 'block';
            
            initializeApp(activeUser); 
        }

        function removeFriendLogic(friendId) {
            if (!confirm("Вы уверены, что хотите удалить этого друга?")) return;

            const token = localStorage.getItem(USER_TOKEN_KEY);
            let activeUser = findUserByToken(token);
            let friendToRemove = getAllUsers().find(u => u.id === friendId);

            if (!activeUser || !friendToRemove) return;

            // Удаление из списка текущего пользователя
            activeUser.friends = activeUser.friends.filter(id => id !== friendId);
            saveUser(activeUser);

            // Удаление из списка друга
            if (friendToRemove.friends) {
                friendToRemove.friends = friendToRemove.friends.filter(id => id !== activeUser.id);
                saveUser(friendToRemove);
            }

            initializeApp(activeUser);
        }
        
        // --- ФОРМИРОВАНИЕ HTML КОНТЕНТА ---

        function getFriendsHomeContent() {
            const friends = currentActiveUser.friends.map(friendId => 
                getAllUsers().find(u => u.id === friendId)
            ).filter(f => f !== undefined);

            let friendsListHTML = '';
            
            if (friends.length === 0) {
                friendsListHTML = `<p style="color: var(--text-secondary); font-size: 14px; margin-top: 15px; padding: 0 10px;">Начните добавлять друзей с помощью его полного тега (Имя#XXXX).</p>`;
            } else {
                friendsListHTML = friends.map(friend => `
                    <div class="friends-list-item" data-friend-id="${friend.id}">
                        <div class="friend-info">
                            <div class="friend-avatar">
                                <span class="friend-status status-online"></span>
                            </div>
                            <div class="friend-name-tag">
                                <strong>${friend.username}</strong>
                                <small>В сети</small>
                                <small style="color: var(--text-secondary); margin-left: 5px;">${friend.discriminator || '#0000'}</small>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <i class="fas fa-comment" title="Начать чат"></i>
                            <i class="fas fa-user-times remove-friend-btn" title="Удалить друга" data-friend-id="${friend.id}"></i>
                        </div>
                    </div>
                `).join('');
            }

            const currentDisc = currentActiveUser.discriminator || '#0000';
            return `
                <div class="friends-content" style="padding: 0 10px;">
                    <div class="add-friend-form-container">
                        <h3>ДОБАВИТЬ В ДРУЗЬЯ</h3>
                        <p>Вы можете добавить друга с помощью его полного тега (например, ${currentActiveUser.username}${currentDisc}).</p>
                        <form id="addFriendForm" class="add-friend-input-group">
                            <input type="text" id="friendTagInput" placeholder="Введите имя пользователя#дискриминатор">
                            <button type="submit">Отправить запрос</button>
                        </form>
                        <div id="addFriendMessage" class="add-friend-message"></div>
                    </div>

                    <h2 style="color: var(--text-secondary); padding-bottom: 10px; margin-bottom: 10px;">ДРУЗЬЯ — ${friends.length}</h2>
                    <div id="friendsListContainer">
                        ${friendsListHTML}
                    </div>
                </div>
            `;
        }

        function getNitroContent() { return `<div class="friends-content"><h2>DISCORD NITRO</h2><p style="color: var(--text-secondary); font-size: 14px;">Покупайте Nitro и поддержите нас!</p></div>`; }
        function getStoreContent() { return `<div class="friends-content"><h2>МАГАЗИН</h2><p style="color: var(--text-secondary); font-size: 14px;">Эксклюзивные товары.</p></div>`; }
        function getTasksContent() { return `<div class="friends-content"><h2>ЗАДАНИЯ</h2><p style="color: var(--text-secondary); font-size: 14px;">Нет активных заданий.</p></div>`; }
        
        function getFriendsNav() {
            return `
                <div class="nav-item active-tab" data-target="friends-home">
                    <i class="fas fa-user-friends"></i> Друзья
                </div>
                <div class="nav-item" data-target="nitro">
                    <i class="fas fa-crown"></i> Nitro
                </div>
                <div class="nav-item" data-target="store">
                    <i class="fas fa-store"></i> Магазин
                </div>
                <div class="nav-item" data-target="tasks">
                    <i class="fas fa-cog"></i> Задания
                </div>
                <div class="dm-category">
                    Личные сообщения <i class="fas fa-plus" style="font-size: 10px; cursor: pointer;"></i>
                </div>
                `;
        }

        // --- ЛОГИКА ЗАГРУЗКИ КОНТЕНТА И ОБРАБОТЧИКИ ---
        function loadContent(key) {
            const data = contentData[key];
            
            chatHeaderContent.innerHTML = `<i class="${data.icon}" style="margin-right: 8px; color: ${key === 'friends-home' ? 'var(--text-primary)' : 'var(--text-secondary)'};"></i>${data.title}`;
            
            if (typeof data.content === 'function') {
                messageList.innerHTML = data.content();
            } else {
                messageList.innerHTML = data.content;
            }
            
            chatForm.style.display = data.hasInput ? 'flex' : 'none';
            
            if (key === 'friends-home') {
                const addFriendForm = document.getElementById('addFriendForm');
                const friendsListContainer = document.getElementById('friendsListContainer');

                if (addFriendForm) {
                    addFriendForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const tagInput = document.getElementById('friendTagInput');
                        addFriendLogic(tagInput.value);
                        tagInput.value = '';
                    });
                }
                
                if (friendsListContainer) {
                    friendsListContainer.addEventListener('click', function(e) {
                        const removeBtn = e.target.closest('.remove-friend-btn');
                        if (removeBtn) {
                            const friendId = removeBtn.getAttribute('data-friend-id');
                            removeFriendLogic(friendId);
                        }
                    });
                }
            }
        }
        
        // --- ОБРАБОТЧИКИ АУТЕНТИФИКАЦИИ И ИНИЦИАЛИЗАЦИЯ ---

        registerForm.addEventListener('submit', function(event) {
            event.preventDefault();
            registerErrorMsg.style.display = 'none';
            registerSuccessMsg.style.display = 'none';
            const email = document.getElementById('regEmail').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            
            if (!email || !username || !password) {
                registerErrorMsg.textContent = 'Пожалуйста, заполните все поля.';
                registerErrorMsg.style.display = 'block';
                return;
            }
            if (findUserByEmail(email)) {
                registerErrorMsg.textContent = 'Пользователь с таким email уже существует.';
                registerErrorMsg.style.display = 'block';
                return;
            }

            const newUser = {
                email: email,
                username: username,
                password: encryptPassword(password), 
                token: null,
                id: Date.now().toString(),
                friends: [],
                discriminator: generateDiscriminator() // Генерируем дискриминатор
            };
            
            saveUser(newUser);
            
            // Показываем пользователю его новый полный тег
            registerSuccessMsg.innerHTML = `Аккаунт создан! Ваш тег: <strong>${newUser.username}${newUser.discriminator}</strong>`;
            registerSuccessMsg.style.display = 'block';
            
            registerForm.reset(); 
            setTimeout(() => { showScreen('login'); }, 3000); // Даем время прочитать тег
        });

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            loginErrorMsg.style.display = 'none';
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const user = findUserByEmail(email);
            if (user && decryptPassword(user.password) === password) {
                loginUser(user);
            } else {
                loginErrorMsg.style.display = 'block';
            }
        });

        logoutButton.addEventListener('click', logoutUser);
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showScreen('register'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showScreen('login'); });

        function showScreen(screenName) {
            loginScreen.style.display = 'none';
            registerScreen.style.display = 'none';
            mainApp.style.display = 'none';
            if (screenName === 'login') {
                loginScreen.style.display = 'block';
                loginErrorMsg.style.display = 'none';
            } else if (screenName === 'register') {
                registerScreen.style.display = 'block';
                registerErrorMsg.style.display = 'none';
                registerSuccessMsg.style.display = 'none';
            } else if (screenName === 'app') {
                mainApp.style.display = 'flex';
            }
        }

        channelList.addEventListener('click', (e) => {
            const item = e.target.closest('.nav-item');
            if (!item) return;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active-tab'));
            item.classList.add('active-tab');
            const targetKey = item.getAttribute('data-target');
            if (targetKey) { loadContent(targetKey); }
        });

        document.querySelector('.servers-panel').addEventListener('click', (e) => {
            const icon = e.target.closest('.server-icon');
            if (!icon) return;
            document.querySelectorAll('.server-icon').forEach(i => i.classList.remove('active'));
            icon.classList.add('active');
            if (icon.id === 'friendsServerIcon') {
                document.getElementById('channelHeader').innerHTML = '<input type="text" placeholder="Найти или начать беседу">';
                channelList.innerHTML = getFriendsNav();
                loadContent('friends-home');
            } 
        });

        function checkSessionToken() {
            const token = localStorage.getItem(USER_TOKEN_KEY);
            if (token) {
                const user = findUserByToken(token);
                if (user) {
                    initializeApp(user); 
                    return;
                } else {
                    localStorage.removeItem(USER_TOKEN_KEY);
                }
            }
            showScreen('login');
        }
        
        checkSessionToken(); 
    </script>
</body>
</html>
